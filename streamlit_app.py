import streamlit as st
from openai import OpenAI
from parse_hh import get_html, extract_vacancy_data, extract_resume_data

client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

SYSTEM_PROMPT = """
–û–±—â–∞—è —Ü–µ–ª—å
–û—Ü–µ–Ω–∏—Ç—å —Ä–µ–∑—é–º–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç –∏ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.

–®–∞–≥–∏ –∞–Ω–∞–ª–∏–∑–∞
1. –ò–∑—É—á–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏
–í—ã–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏, –æ–ø—ã—Ç, —É—Ä–æ–≤–µ–Ω—å).
–ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (KPI, –ø—Ä–æ–µ–∫—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏).
–û–ø—Ä–µ–¥–µ–ª–∏ ¬´–∂—ë—Å—Ç–∫–∏–µ¬ª —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –æ–ø—ã—Ç).
–û–ø—Ä–µ–¥–µ–ª–∏ ¬´–º—è–≥–∫–∏–µ¬ª —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (—É–º–µ–Ω–∏–µ –≤ –∫–æ–º–∞–Ω–¥–µ, –∞–Ω–∞–ª–∏—Ç–∏—á–Ω–æ—Å—Ç—å).

2. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ
–û–ø—Ä–µ–¥–µ–ª–∏ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —Ä–∞–±–æ—Ç–∞–ª –∫–∞–Ω–¥–∏–¥–∞—Ç.
–£–∫–∞–∂–∏, –∫–∞–∫ –æ–Ω –∏—Ö —Ä–µ—à–∞–ª (–º–µ—Ç–æ–¥—ã, –ø–æ–¥—Ö–æ–¥—ã).
–û—Ç–º–µ—Ç—å, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (—Ü–∏—Ñ—Ä—ã, —ç—Ñ—Ñ–µ–∫—Ç—ã).
–ü—Ä–æ–≤–µ—Ä—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞, —Å—Ç–∏–ª—å, –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–≤–æ–µ–π —Ä–æ–ª–∏.

3. –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
–ö—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç (5‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π):
–£—Ä–æ–≤–µ–Ω—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏.
–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (–æ–ø—ã—Ç, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è).
–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ (–ø—Ä–æ–±–µ–ª—ã, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ).
–ó–∞–∫–ª—é—á–µ–Ω–∏–µ: —Å–ø–æ—Å–æ–±–µ–Ω –ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á–∏.

4. –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—é–º–µ
–ó–∞–¥–∞—á–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –¥–æ 3 –±–∞–ª–ª–æ–≤.
–ú–µ—Ç–æ–¥—ã —Ä–µ—à–µ–Ω–∏–π ‚Äî –¥–æ 2 –±–∞–ª–ª–æ–≤.
–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è ‚Äî –¥–æ 3 –±–∞–ª–ª–æ–≤.
–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ‚Äî –¥–æ 2 –±–∞–ª–ª–æ–≤.

5. –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
–ò—Ç–æ–≥ –ø–æ —à–∫–∞–ª–µ 1‚Äì10, —É—á–∏—Ç—ã–≤–∞—è –æ–ø—ã—Ç, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ.
–ü—Ä–∏ –ø—Ä–æ–±–µ–ª–∞—Ö –≤ –æ–ø—ã—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª —Å–Ω–∏–∂–∞–π, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

–§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
"–ö–∞–Ω–¥–∏–¥–∞—Ç –æ–±–ª–∞–¥–∞–µ—Ç –æ–ø—ã—Ç–æ–º ‚Ä¶ –ó–∞–¥–∞—á–∏ –æ–ø–∏—Å–∞–Ω—ã/–Ω–µ –æ–ø–∏—Å–∞–Ω—ã ‚Ä¶ –ú–µ—Ç–æ–¥—ã —É–∫–∞–∑–∞–Ω—ã/–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Ä¶ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –µ—Å—Ç—å/–Ω–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã ‚Ä¶ –†–µ–∑—é–º–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ/–æ—Ñ–æ—Ä–º–ª–µ–Ω–æ —Å–ª–∞–±–æ ‚Ä¶ –í —Ü–µ–ª–æ–º –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç/—á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç/–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç."

–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—é–º–µ: X/10

–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏: Y/10
""".strip()

def request_gpt(system_prompt, user_prompt):
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
        max_tokens=1000,
        temperature=0,
    )
    return response.choices[0].message.content

# UI
st.title('CV Scoring App')

job_description = st.text_area('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é')
cv = st.text_area('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–∑—é–º–µ')

if st.button("–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ"):
    with st.spinner("–ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GPT..."):
        try:
            job_html = get_html(job_description).text
            resume_html = get_html(cv).text

            job_text = extract_vacancy_data(job_html)
            resume_text = extract_resume_data(resume_html)

            prompt = f"# –í–ê–ö–ê–ù–°–ò–Ø\n{job_text}\n\n# –†–ï–ó–Æ–ú–ï\n{resume_text}"
            response = request_gpt(SYSTEM_PROMPT, prompt)

            st.subheader("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:")
            st.markdown(response)

        except Exception as e:

            st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
